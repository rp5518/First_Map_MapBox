<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Mapbox Markers from JSON</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" type="text/css">
    <style>
        html,body { margin: 0; padding: 0; height: 100%; }
        #map {
            width: 100%;
            flex-grow: 1;
            height: 100%;
        }
        #container {
            display: flex;
            height: 100%;
        }
        /* Remove the sidebar styles */
        #sidebar {
            display: none;
        }
        button {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            width: 150px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <button id="zoom-to-markers" style="position:absolute;top:60px;left:20px;z-index:2;width:150px;padding:10px;background-color:#fff;">Zoom to Markers</button>
        <button id="zoom-to-include-me" style="position:absolute;top:100px;left:20px;z-index:2;width:150px;padding:10px;background-color:#fff;">Zoom to Include Me</button>
        <div id="map"></div>
    </div>
    <!-- Firebase SDKs -->
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore-compat.js"></script>
    <script>
        // ADD YOUR ACCESS TOKEN FROM https://account.mapbox.com
        const INITIAL_CENTER = [-112, 33.3]; // Centered on the Ahwhatukee Foothills
        const INITIAL_ZOOM = 1.5; // Start zoomed out for globe effect
        mapboxgl.accessToken = 'pk.eyJ1Ijoid2pncnA1NTE4IiwiYSI6ImNtZmxxMm01MzA3c3oyaXExMWMxamVqZWoifQ.u2vTBRK2tHKi1HwI2JkhfA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v12',
            zoom: INITIAL_ZOOM,
            center: INITIAL_CENTER,
            projection: 'globe' // Enable globe view
        });

        // Add the geocoder control to the map.
        map.addControl(
            new MapboxGeocoder({
                accessToken: mapboxgl.accessToken,
                useBrowserFocus: true,
                mapboxgl: mapboxgl,
                limit: 10,
            })
        );

        // Add geolocation control and tracking
        map.addControl(new mapboxgl.GeolocateControl({
            positionOptions: {
                enableHighAccuracy: true
            },
            trackUserLocation: true,
            showUserHeading: true,
            showAccuracyCircle: true
        }));

        // Variable to store the current location marker
        let currentLocationMarker = null;

        // Function to create a custom current location marker
        function createCurrentLocationMarker() {
            const el = document.createElement('div');
            el.style.backgroundColor = '#FF0000'; // Red color for current location
            el.style.width = '20px';
            el.style.height = '20px';
            el.style.borderRadius = '50%';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.justifyContent = 'center';
            el.style.color = 'white';
            el.style.fontWeight = 'bold';
            el.style.fontSize = '12px';
            el.style.border = '3px solid white';
            el.style.boxShadow = '0 0 10px rgba(0,0,0,0.5)';
            el.textContent = 'ðŸ“';
            return el;
        }

        // Track user's current location
        function trackCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(
                    (position) => {
                        const { longitude, latitude } = position.coords;
                        
                        // Remove existing current location marker
                        if (currentLocationMarker) {
                            currentLocationMarker.remove();
                        }
                        
                        // Create new current location marker
                        const locationMarkerEl = createCurrentLocationMarker();
                        
                        const popup = new mapboxgl.Popup({ offset: 25 })
                            .setHTML(`
                                <strong>Your Current Location</strong><br>
                                Lat: ${latitude.toFixed(6)}<br>
                                Lng: ${longitude.toFixed(6)}<br>
                                <small>Accuracy: Â±${position.coords.accuracy}m</small>
                            `);
                        
                        currentLocationMarker = new mapboxgl.Marker(locationMarkerEl)
                            .setLngLat([longitude, latitude])
                            .setPopup(popup)
                            .addTo(map);
                        
                        console.log('Location updated:', latitude, longitude);
                    },
                    (error) => {
                        console.error('Geolocation error:', error);
                        alert('Unable to retrieve your location. Please enable location services.');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000 // Cache location for 1 minute
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        // Start tracking location when map loads
        map.on('load', () => {
            trackCurrentLocation();
        });

        // Store marker references and visited state
        const markerObjects = [];

        // Function to create a custom marker element with a visible numeric label
        function createMarkerElement(label) {
            const el = document.createElement('div');
            el.style.backgroundColor = '#FFFF00'; // Always start as yellow
            el.style.width = '28px';
            el.style.height = '28px';
            el.style.borderRadius = '50%';
            el.style.display = 'flex';
            el.style.alignItems = 'center';
            el.style.justifyContent = 'center';
            el.style.color = 'black';
            el.style.fontWeight = 'bold';
            el.style.fontSize = '16px';
            el.style.border = '2px solid black';
            el.textContent = label;
            return el;
        }

        // Place this BEFORE fetch('markers.json')
        function setMarkerShape(markerEl, isStar, label) {
            if (isStar) {
                markerEl.style.backgroundColor = markerEl.style.backgroundColor || '#FFFF00';
                markerEl.style.width = '42px';
                markerEl.style.height = '42px';
                markerEl.style.borderRadius = '0';
                markerEl.style.fontSize = '16px';
                markerEl.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                markerEl.textContent = label;
            } else {
                markerEl.style.width = '28px';
                markerEl.style.height = '28px';
                markerEl.style.borderRadius = '50%';
                markerEl.style.clipPath = '';
                markerEl.style.border = '2px solid black';
                markerEl.style.fontSize = '16px';
                markerEl.textContent = label;
            }
        }

        // Load markers from markers.json and add to map with numeric labels
        fetch('markers.json')
            .then(response => response.json())
            .then(markers => {
                markers.forEach((marker, idx) => {
                    let visited = false;
                    const markerEl = createMarkerElement(idx + 1);

                    const popupContent = document.createElement('div');
                    popupContent.innerHTML = `
                        <strong>${marker.first} ${marker.last}</strong><br>
                        ${marker.address}<br>
                        <label>
                            <input type="checkbox" id="visited-${idx}"> Dropped Literature
                        </label><br>
                        <label>
                            <input type="checkbox" id="friendly-${idx}"> Friendly
                        </label><br>
                        <label>
                            <input type="checkbox" id="notfriendly-${idx}"> Not Friendly
                        </label><br>
                        <label>
                            <input type="checkbox" id="reset-${idx}"> Reset
                        </label><br>
                        <label>
                            <input type="checkbox" id="flag-${idx}"> American Flag
                        </label><br>
                        <label style="display: block; margin-top: 10px;">
                            <strong>Notes:</strong><br>
                            <textarea id="notes-${idx}" placeholder="Add new note..." 
                                     style="width: 200px; height: 60px; margin-top: 5px; 
                                            resize: vertical; font-family: Arial, sans-serif; 
                                            font-size: 12px; padding: 5px;"></textarea><br>
                            <button type="button" id="add-note-${idx}" 
                                   style="margin-top: 5px; padding: 5px 10px; 
                                          background-color: #4CAF50; color: white; 
                                          border: none; border-radius: 3px; cursor: pointer;">
                                Add Note
                            </button>
                            <div id="notes-history-${idx}" 
                                 style="margin-top: 10px; max-height: 150px; 
                                        overflow-y: auto; border: 1px solid #ddd; 
                                        padding: 5px; background-color: #f9f9f9; 
                                        font-size: 11px;">
                                <em>No notes yet</em>
                            </div>
                        </label>
                    `;

                    const popup = new mapboxgl.Popup({ offset: 25 }).setDOMContent(popupContent);

                    const mapMarker = new mapboxgl.Marker(markerEl)
                        .setLngLat([marker.lng, marker.lat])
                        .setPopup(popup)
                        .addTo(map);

                    markerObjects.push({ marker, idx, mapMarker, markerEl, popupContent });

                    const visitedBox = popupContent.querySelector(`#visited-${idx}`);
                    const friendlyBox = popupContent.querySelector(`#friendly-${idx}`);
                    const notFriendlyBox = popupContent.querySelector(`#notfriendly-${idx}`);
                    const resetBox = popupContent.querySelector(`#reset-${idx}`);
                    const flagBox = popupContent.querySelector(`#flag-${idx}`);
                    const notesBox = popupContent.querySelector(`#notes-${idx}`);
                    const addNoteBtn = popupContent.querySelector(`#add-note-${idx}`);
                    const notesHistory = popupContent.querySelector(`#notes-history-${idx}`);

                    // Functions for timestamped notes
                    function addTimestampedNote(idx, noteText) {
                        if (!noteText.trim()) return;
                        
                        const timestamp = new Date().toLocaleString();
                        const noteEntry = {
                            text: noteText.trim(),
                            timestamp: timestamp,
                            id: Date.now() // Unique ID for each note
                        };
                        
                        // Get existing notes from Firebase
                        db.collection('markerStates').doc(String(idx)).get().then(doc => {
                            const data = doc.data() || {};
                            const existingNotes = data.notesHistory || [];
                            const updatedNotes = [...existingNotes, noteEntry];
                            
                            // Update Firebase with new note
                            db.collection('markerStates').doc(String(idx)).update({
                                notesHistory: updatedNotes
                            });
                            
                            // Clear the input
                            notesBox.value = '';
                        });
                    }
                    
                    function displayNotesHistory(idx, notesHistoryArray) {
                        const historyDiv = popupContent.querySelector(`#notes-history-${idx}`);
                        if (!notesHistoryArray || notesHistoryArray.length === 0) {
                            historyDiv.innerHTML = '<em>No notes yet</em>';
                            return;
                        }
                        
                        historyDiv.innerHTML = notesHistoryArray
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp)) // Most recent first
                            .map(note => `
                                <div style="margin-bottom: 8px; padding: 5px; 
                                           background-color: white; border-left: 3px solid #4CAF50;">
                                    <div style="font-weight: bold; color: #666; font-size: 10px;">
                                        ${note.timestamp}
                                    </div>
                                    <div style="margin-top: 2px;">
                                        ${note.text}
                                    </div>
                                </div>
                            `).join('');
                    }

                    // Move these functions OUTSIDE the forEach loop
                    function setMarkerShape(markerEl, isStar, label) {
                        if (isStar) {
                            markerEl.style.backgroundColor = markerEl.style.backgroundColor || '#FFFF00';
                            markerEl.style.width = '42px';
                            markerEl.style.height = '42px';
                            markerEl.style.borderRadius = '0';
                            markerEl.style.fontSize = '16px';
                            markerEl.style.clipPath = 'polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%)';
                            markerEl.textContent = label;
                        } else {
                            markerEl.style.width = '28px';
                            markerEl.style.height = '28px';
                            markerEl.style.borderRadius = '50%';
                            markerEl.style.clipPath = '';
                            markerEl.style.border = '2px solid black';
                            markerEl.style.fontSize = '16px';
                            markerEl.textContent = label;
                        }
                    }

                    function handleExclusiveCheck(markerEl, visitedBox, friendlyBox, notFriendlyBox, resetBox, flagBox, idx, selectedBox) {
                        [visitedBox, friendlyBox, notFriendlyBox].forEach(box => {
                            if (box !== selectedBox) box.checked = false;
                        });
                        resetBox.checked = false;

                        let state = '';
                        if (friendlyBox.checked) {
                            markerEl.style.backgroundColor = '#32CD32'; // Friendly: green
                            state = 'friendly';
                        } else if (notFriendlyBox.checked) {
                            markerEl.style.backgroundColor = '#FF4500'; // Not Friendly: orange-red
                            state = 'notfriendly';
                        } else if (visitedBox.checked) {
                            markerEl.style.backgroundColor = '#B39DDB'; // Dropped Literature: softer purple
                            state = 'visited';
                        } else {
                            markerEl.style.backgroundColor = '#FFFF00'; // Default: yellow
                            state = '';
                        }
                        setMarkerShape(markerEl, flagBox.checked, idx + 1);

                        db.collection('markerStates').doc(String(idx)).set({ 
                            state, 
                            flag: flagBox.checked
                        }, { merge: true });
                    }

                    // Reset logic
                    resetBox.addEventListener('change', () => {
                        if (resetBox.checked) {
                            visitedBox.checked = false;
                            friendlyBox.checked = false;
                            notFriendlyBox.checked = false;
                            markerEl.style.backgroundColor = '#FFFF00';
                            notesBox.value = '';
                            setMarkerShape(markerEl, flagBox.checked, idx + 1);
                            db.collection('markerStates').doc(String(idx)).set({ 
                                state: '', 
                                flag: flagBox.checked,
                                notesHistory: [] // Clear all notes history
                            }, { merge: true });
                            resetBox.checked = false; // Uncheck after reset
                        }
                    });

                    // American Flag logic (independent)
                    flagBox.addEventListener('change', () => {
                        setMarkerShape(markerEl, flagBox.checked, idx + 1);
                        let state = '';
                        if (friendlyBox.checked) state = 'friendly';
                        else if (notFriendlyBox.checked) state = 'notfriendly';
                        else if (visitedBox.checked) state = 'visited';
                        db.collection('markerStates').doc(String(idx)).set({ 
                            state, 
                            flag: flagBox.checked
                        }, { merge: true });
                    });

                    // Attach event listeners for exclusive selection
                    visitedBox.addEventListener('change', () => handleExclusiveCheck(markerEl, visitedBox, friendlyBox, notFriendlyBox, resetBox, flagBox, idx, visitedBox));
                    friendlyBox.addEventListener('change', () => handleExclusiveCheck(markerEl, visitedBox, friendlyBox, notFriendlyBox, resetBox, flagBox, idx, friendlyBox));
                    notFriendlyBox.addEventListener('change', () => handleExclusiveCheck(markerEl, visitedBox, friendlyBox, notFriendlyBox, resetBox, flagBox, idx, notFriendlyBox));

                    // Initialize marker state in Firestore if it doesn't exist
                    db.collection('markerStates').doc(String(idx)).get().then(doc => {
                        if (!doc.exists) {
                            db.collection('markerStates').doc(String(idx)).set({ 
                                state: '', 
                                flag: false, 
                                notesHistory: []
                            });
                        }
                    });

                    // Add note button functionality
                    addNoteBtn.addEventListener('click', () => {
                        addTimestampedNote(idx, notesBox.value);
                    });
                    
                    // Allow Enter key to add note
                    notesBox.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter' && !e.shiftKey) {
                            e.preventDefault();
                            addTimestampedNote(idx, notesBox.value);
                        }
                    });
                });
            })
            .catch(error => {
                console.error('Error loading markers.json:', error);
            });

        // Globe spinning logic
        let spinning = true;
        let spinSpeed = 0.5; // degrees per frame
        let spinAnimationId = null;

        function spinGlobe() {
            if (!spinning) return;
            const center = map.getCenter();
            map.easeTo({
                center: [center.lng + spinSpeed, center.lat],
                duration: 50,
                easing: t => t
            });
            spinAnimationId = requestAnimationFrame(spinGlobe);
        }

        // Start spinning on style load
        map.on('style.load', () => {
            spinning = true;
            spinGlobe();
        });

        // Pause spinning when user interacts with the map
        function pauseSpinning() {
            spinning = false;
            if (spinAnimationId) {
                cancelAnimationFrame(spinAnimationId);
                spinAnimationId = null;
            }
        }

        map.on('mousedown', pauseSpinning);
        map.on('wheel', pauseSpinning);
        map.on('touchstart', pauseSpinning);

        // Zoom to Markers
        document.getElementById('zoom-to-markers').addEventListener('click', () => {
            pauseSpinning();
            if (markerObjects.length === 0) return;
            const bounds = new mapboxgl.LngLatBounds();
            markerObjects.forEach(obj => {
                bounds.extend([obj.marker.lng, obj.marker.lat]);
            });
            map.fitBounds(bounds, {
                padding: 50,
                maxZoom: 16 // Prevent zooming in too close
            });
        });

        // Zoom to Include Me
        document.getElementById('zoom-to-include-me').addEventListener('click', () => {
            pauseSpinning();
            if (markerObjects.length === 0 && !currentLocationMarker) return;
            
            const bounds = new mapboxgl.LngLatBounds();
            
            // Add all marker locations to bounds
            markerObjects.forEach(obj => {
                bounds.extend([obj.marker.lng, obj.marker.lat]);
            });
            
            // Add current location to bounds if available
            if (currentLocationMarker) {
                const currentLngLat = currentLocationMarker.getLngLat();
                bounds.extend([currentLngLat.lng, currentLngLat.lat]);
            }
            
            map.fitBounds(bounds, {
                padding: 50,
                maxZoom: 16 // Prevent zooming in too close
            });
        });

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCm-dDUMYN4JLdIyt0FT0BzBIRLCHXm8EU",
            authDomain: "maps4canvasing.firebaseapp.com",
            projectId: "maps4canvasing",
            storageBucket: "maps4canvasing.firebasestorage.app",
            messagingSenderId: "913974581293",
            appId: "1:913974581293:web:201a7403bc5d9c82d900a4",
            measurementId: "G-X0G2YNP37H"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Update marker from Firestore
        db.collection('markerStates').onSnapshot(snapshot => {
            snapshot.forEach(doc => {
                const idx = parseInt(doc.id);
                const data = doc.data();
                const state = data.state;
                const flag = data.flag;
                const notesHistory = data.notesHistory || [];
                const obj = markerObjects.find(o => o.idx === idx);
                if (!obj) return;
                obj.popupContent.querySelector(`#friendly-${idx}`).checked = state === 'friendly';
                obj.popupContent.querySelector(`#notfriendly-${idx}`).checked = state === 'notfriendly';
                obj.popupContent.querySelector(`#visited-${idx}`).checked = state === 'visited';
                obj.popupContent.querySelector(`#flag-${idx}`).checked = !!flag;
                obj.popupContent.querySelector(`#reset-${idx}`).checked = false;
                
                // Display notes history
                const historyDiv = obj.popupContent.querySelector(`#notes-history-${idx}`);
                if (!notesHistory || notesHistory.length === 0) {
                    historyDiv.innerHTML = '<em>No notes yet</em>';
                } else {
                    historyDiv.innerHTML = notesHistory
                        .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                        .map(note => `
                            <div style="margin-bottom: 8px; padding: 5px; 
                                       background-color: white; border-left: 3px solid #4CAF50;">
                                <div style="font-weight: bold; color: #666; font-size: 10px;">
                                    ${note.timestamp}
                                </div>
                                <div style="margin-top: 2px;">
                                    ${note.text}
                                </div>
                            </div>
                        `).join('');
                }
                
                if (state === 'friendly') obj.markerEl.style.backgroundColor = '#32CD32';
                else if (state === 'notfriendly') obj.markerEl.style.backgroundColor = '#FF4500';
                else if (state === 'visited') obj.markerEl.style.backgroundColor = '#B39DDB';
                else obj.markerEl.style.backgroundColor = '#FFFF00';
                if (flag) setMarkerShape(obj.markerEl, true, idx + 1);
                else setMarkerShape(obj.markerEl, false, idx + 1);
            });
            console.log('Firestore update received', snapshot.docs.map(doc => doc.data()));
        });
    </script>
</body>
</html>