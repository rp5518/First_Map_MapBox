<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Create a rotating globe</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.15.0/mapbox-gl.js"></script>
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.1.0/mapbox-gl-geocoder.css" type="text/css">
    <style>
       html,body { margin: 0; padding: 0; height: 100%; }
        #btn-spin {
            font: bold 12px/20px 'Helvetica Neue', Arial, Helvetica, sans-serif;
            background-color: #3386c0;
            color: #fff;
            position: absolute;
            top: 20px;
            left: 55%;
            z-index: 1;
            border: none;
            width: 200px;
            margin-left: -100px;
            display: block;
            cursor: pointer;
            padding: 10px 20px;
            border-radius: 3px;
        }
        #btn-spin:hover {
            background-color: #4ea0da;
        }
        #map {
            /* position: absolute; */
            /* top: 0; */
            /* bottom: 0; */
            width: 100%;
            flex-grow: 1;
            height: 100%;
        }
        #container {
            display: flex;
            height: 100%;
        }
        #sidebar {
            width: fit-content;
            flex-shrink: 0;
            height: 100%;
            padding: 3px;
            background-color: rgb(229, 255, 0);
        }
        button {
            display: block;
            margin-bottom: 10px;
            padding: 10px;
            width: 150px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="sidebar">
            <button id="fly-to-coney-island">Fly_to_Coney_Island</button>
            <button id="fit-to-brooklyn">Fit_to_Brooklyn</button>
            <button id="reset-map">Reset Map</button>
            <button id="toggle-borough-boundaries">Toggle Borough Boundaries</button>
        </div>
        <div id="map"></div>
        <button id="btn-spin">Pause rotation</button>
    </div>
    <script>
        // TO MAKE THE MAP APPEAR YOU MUST
        // ADD YOUR ACCESS TOKEN FROM
        // https://account.mapbox.com
        const INITIAL_CENTER = [-73.95068, 40.49];
        const INITIAL_ZOOM = 1.5;
        mapboxgl.accessToken = 'pk.eyJ1Ijoid2pncnA1NTE4IiwiYSI6ImNtZmxxMm01MzA3c3oyaXExMWMxamVqZWoifQ.u2vTBRK2tHKi1HwI2JkhfA';
        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/satellite-streets-v12',
            zoom: INITIAL_ZOOM,
            center: INITIAL_CENTER // starting position [lng, lat]
        });

    // Add the control to the map.
    map.addControl(
        new MapboxGeocoder({
            accessToken: mapboxgl.accessToken,
            useBrowserFocus: true,
            mapboxgl: mapboxgl,
            limit: 10,
        })
    );

        function createMarkerElement() {
            const el = document.createElement('div');
            el.style.backgroundColor = '#27B72E';
            el.style.width = '24px';
            el.style.height = '24px';
            el.style.borderRadius = '80%';
            return el;
        }

        // Marker 1
        new mapboxgl.Marker(createMarkerElement())
            .setLngLat([-73.94605, 40.67841])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML('<h3>Brooklyn</h3><p>Real Dump.</p>'))
            .addTo(map);

        // Marker 2
        new mapboxgl.Marker(createMarkerElement())
            .setLngLat([-73.79687, 40.73241])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML('<h3>Queens</h3><p>Another Real Dump.</p>'))
            .addTo(map);

        // Marker 3
        new mapboxgl.Marker(createMarkerElement())
            .setLngLat([-74.14637, 40.59022])
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML('<h3>Staten Island</h3><p>Third Real Dump.</p>'))
            .addTo(map);

        map.on('style.load', () => {
            map.addSource('borough-boundaries', {
                'type': 'geojson',
                'data': 'data/borough-boundaries.geojson',
                'promoteId': 'BoroCode' // Use BoroCode as the feature id
            });
            map.addLayer({
                'id': 'borough-boundaries-layer',
                'type': 'fill',
                'source': 'borough-boundaries',
                'paint': {
                    'fill-color': [
                        'match', [
                            'get', 'BoroName'
                        ],
                        'Staten Island', 'pink',
                        'Bronx', 'green',
                        'Brooklyn', 'blue',
                        'Manhattan', 'purple',
                        /* default */ 'yellow'
                    ],
                    'fill-opacity': [
                      'case',
                      ['boolean', ['feature-state', 'hover'], false],
                      1,
                      0.5
                    ]
                },
                layout : {
                    'visibility': 'visible'
                }
            },'road-label'); // Place text labels on top of the polygon layer

            map.addLayer({
                'id': 'borough-boundaries-outline',
                'type': 'line',
                'source': 'borough-boundaries',
                'paint': {
                    'line-color': 'red',
                    'line-width': 3
                }
            },'road-label'); // Place text labels on top of the polygon layer
            map.on('click', (e) => {
                console.log('click', e.point)
                const [selectedBorough] = map.queryRenderedFeatures(e.point, {
                    layers: ['borough-boundaries-layer']
                })
                if (selectedBorough) {
                    const { BoroName, Pop_2024 } = selectedBorough.properties; // Destructure properties
                    alert(`The population of ${BoroName} in 2024 is ${Pop_2024}.`);
                    // new mapboxgl.Popup()
                    //     .setLngLat(e.lngLat)
                    //     .setHTML(`<strong>Borough:</strong> ${selectedBorough.properties.BoroName}`)
                    //     .addTo(map);
                }
                //console.log(selectedBorough)
            });

            let hoverStateId = null;
            map.on('mousemove', 'borough-boundaries-layer', (e) => {
                if (e.features.length > 0) {
                    if (hoverStateId !== null) {
                        map.setFeatureState(
                            { source: 'borough-boundaries', id: hoverStateId },
                            { hover: false }
                        );
                    }
                    hoverStateId = e.features[0].id;
                    map.setFeatureState(
                        { source: 'borough-boundaries', id: hoverStateId },
                        { hover: true }
                    );
                }
            });


            map.on('mouseleave', 'borough-boundaries-layer', () => {
                if (hoverStateId !== null) {
                    map.setFeatureState(
                        { source: 'borough-boundaries', id: hoverStateId },
                        { hover: false }
                    );
                }
                hoverStateId = null;
            });
        });
        // The following values can be changed to control rotation speed:
        // At low zooms, complete a revolution every two minutes.
        const secondsPerRevolution = 120;
        // Above zoom level 5, do not rotate.
        const maxSpinZoom = 5;
        // Rotate at intermediate speeds between zoom levels 3 and 5.
        const slowSpinZoom = 3;
        let userInteracting = false;
        let spinEnabled = true;
        function spinGlobe() {
            const zoom = map.getZoom();
            if (spinEnabled && !userInteracting && zoom < maxSpinZoom) {
                let distancePerSecond = 360 / secondsPerRevolution;
                if (zoom > slowSpinZoom) {
                    // Slow spinning at higher zooms
                    const zoomDif = (maxSpinZoom - zoom) / (maxSpinZoom - slowSpinZoom);
                    distancePerSecond *= zoomDif;
                }
                const center = map.getCenter();
                center.lng -= distancePerSecond;
                // Smoothly animate the map over one second.
                // When this animation is complete, it calls a 'moveend' event.
                map.easeTo({ center, duration: 1000, easing: (n) => n });
            }
        }
        // Pause spinning on interaction
        map.on('mousedown', () => {
            userInteracting = true;
        });
        // Restart spinning the globe when interaction is complete
        map.on('mouseup', () => {
            userInteracting = false;
            spinGlobe();
        });
        // These events account for cases where the mouse has moved
        // off the map, so 'mouseup' will not be fired.
        map.on('dragend', () => {
            userInteracting = false;
            spinGlobe();
        });
        map.on('pitchend', () => {
            userInteracting = false;
            spinGlobe();
        });
        map.on('rotateend', () => {
            userInteracting = false;
            spinGlobe();
        });
        // When animation is complete, start spinning if there is no ongoing interaction
        map.on('moveend', () => {
            spinGlobe();
        });
        document.getElementById('btn-spin').addEventListener('click', (e) => {
            spinEnabled = !spinEnabled;
            if (spinEnabled) {
                spinGlobe();
                e.target.innerHTML = 'Pause rotation';
            } else {
                map.stop();
                e.target.innerHTML = 'Resume rotation';
            }
        });
        // Initiate the globe rotation
        spinGlobe();
        // Fly to Coney Island when button is clicked
        document.querySelector('#fly-to-coney-island').addEventListener('click', () => {
            map.flyTo({
                center: [-73.985870, 40.572506],
                zoom: 15,
                pitch: 60
            })
        })

        // Reset the Map View
        document.querySelector('#reset-map').addEventListener('click', () => {
            map.flyTo({
                center: INITIAL_CENTER,
                zoom: INITIAL_ZOOM,
                pitch: 0
            })
        })

        // Toggle Borough Boundaries
        let boundariesVisible = true;
        document.querySelector('#toggle-borough-boundaries').addEventListener('click', () => {
            const isVisible = map.getLayoutProperty('borough-boundaries-layer', 'visibility') === 'visible';
            if (isVisible) {
                map.setLayoutProperty('borough-boundaries-layer', 'visibility', 'none');
                map.setLayoutProperty('borough-boundaries-outline', 'visibility', 'none');
            } else {
                map.setLayoutProperty('borough-boundaries-layer', 'visibility', 'visible');
                map.setLayoutProperty('borough-boundaries-outline', 'visibility', 'visible');
            }
        })

// Fit to Brooklyn
        document.querySelector('#fit-to-brooklyn').addEventListener('click', () => {
            map.fitBounds([
                [-73.9626, 40.8007], // Northeast coordinates
                [-73.8310, 40.5415]  // Southwest coordinates
            ], {
                padding: 20
            });
        })

    </script>
</body>
</html>